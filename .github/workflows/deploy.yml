name: Deploy Spring Boot Application

on:
  push:
    branches:
      - main # –ó–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ –ø—É—à–µ –≤ –≤–µ—Ç–∫—É main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π GitHub runner

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–µ—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Gradle)
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Build with Gradle
        uses: gradle/actions/setup-gradle@v3
      - run: chmod +x gradlew # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π
      - run: ./gradlew clean build -x test

      # 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH-–¥–æ—Å—Ç—É–ø–∞
      - name: Set up SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      # 3. –î–µ–ø–ª–æ–π –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
      - name: Deploy to Server and Restart Service
        run: |
          # 3.1. –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ö–æ—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω (–≤–∞–∂–Ω–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Ä–∞–∑–∞)
          ssh-keyscan ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
          
          # 3.2. –ü–µ—Ä–µ–¥–∞—á–∞ JAR-—Ñ–∞–π–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
          rsync -avz \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./build/libs/altayboots-0.0.1-SNAPSHOT.jar \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/home/${{ secrets.SERVER_USER }}/project/build/libs/
          
          # 3.3. –£–¥–∞–ª–µ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥: –æ—Å—Ç–∞–Ω–æ–≤–∫–∞, –æ—á–∏—Å—Ç–∫–∞, –∑–∞–ø—É—Å–∫
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
            echo 'Deploying and restarting service...'
            # üõë –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∏–º—è –≤–∞—à–µ–π systemd-—Å–ª—É–∂–±—ã!
            sudo systemctl stop altayboots
            # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ –∏–ª–∏ –¥—Ä—É–≥–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ (–ø–æ –∂–µ–ª–∞–Ω–∏—é)
            # –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
            sudo systemctl start altayboots
            echo 'Deployment complete.'"